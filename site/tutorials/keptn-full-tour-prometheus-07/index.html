
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Keptn Full Tour on Prometheus</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-133584243-1"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="keptn-full-tour-prometheus-07"
                  title="Keptn Full Tour on Prometheus"
                  environment="web"
                  feedback-link="https://github.com/keptn/tutorials/tree/master/site/tutorials">
    
      <google-codelab-step label="Welcome" duration="2">
        <p>In this tutorial you&#39;ll get a full tour through Keptn. Before we get started you&#39;ll get to know what you will learn while you walk yourself through this tutorial.</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>How to create a sample project</li>
<li>How to onboard a first microservice</li>
<li>How to deploy your first microservice with blue/green deployments</li>
<li>How to setup quality gates</li>
<li>How to prevent bad builds of your microservice to reach production</li>
<li>How to automatically scale your microservice with Keptn</li>
<li>How to integrate other tools like Slack, MS Team, etc in your Keptn integration</li>
</ul>
<p>You&#39;ll find a time estimate until the end of this tutorial in the right top corner of your screen - this should give you guidance how much time is needed for each step.</p>
<p>In this tutorial, we are going to install Keptn on a Kubernetes cluster, along with Istio for traffic routing and ingress control.</p>
<ul>
<li><a href="https://keptn.sh" target="_blank">Keptn</a> as a control-plane for continuous delivery and automated operations</li>
<li><a href="https://istio.io" target="_blank">Istio</a> as the ingress and service mesh within the cluster for traffic routing between blue/green versions of our services</li>
</ul>
<p>The full setup that we are going to deploy is sketched in the following image.<br><img alt="demo setup" src="img/d63db90c30aa2094.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Bring your own Kubernetes cluster" duration="0">
        <p>Keptn can be installed on a variety of Kubernetes distributions. Please find a full compatibility matrix for supported Kubernetes versions <a href="https://keptn.sh/docs/0.7.x/installation/k8s-support/" target="_blank">here</a>.</p>
<p>Please find tutorials <a href="../../?cat=installation" target="_blank">how to set up your cluster here</a>.</p>
<aside class="special"><p>Please note that if you are following one of the installation tutorials, only steps ①-③ are needed (setup of cluster) since we are going to install Keptn as part of this tutorial.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Install Istio" duration="10">
        <p>Download the Istio command line tool by <a href="https://istio.io/latest/docs/setup/install/" target="_blank">following the official instructions</a> or by executing the following steps.</p>
<pre><code>curl -L https://istio.io/downloadIstio | sh -
</code></pre>
<p>Check the version of Istio that has been downloaded and execute the installer from the corresponding folder, e.g.,</p>
<pre><code>./istio-1.6.5/bin/istioctl install
</code></pre>
<p>The installation of Istio should be finished within a couple of minutes.</p>
<pre><code>This will install the default Istio profile into the cluster. Proceed? (y/N) y
✔ Istio core installed
✔ Istiod installed
✔ Ingress gateways installed
✔ Addons installed
✔ Installation complete
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Download Keptn CLI" duration="3">
        <p>Every release of Keptn provides binaries for the Keptn CLI. These binaries are available for Linux, macOS, and Windows.</p>
<p>There are multiple options how to get the Keptn CLI on your machine.</p>
<ul>
<li>Easiest option, if you are running on a Linux or Mac OS:<pre><code>curl -sL https://get.keptn.sh | sudo -E bash
</code></pre>
This will download and install the Keptn CLI automatically.</li>
<li>Another option is to manually download the current release of the Keptn CLI:<ol type="1">
<li>Download the version for your operating system from <a href="https://github.com/keptn/keptn/releases/tag/0.7.0" target="_blank">Download CLI</a></li>
<li>Unpack the download</li>
<li>Find the <code>keptn</code> binary in the unpacked directory</li>
</ol>
<ul>
<li><em>Linux / macOS</em>: Add executable permissions (<code>chmod +x keptn</code>), and move it to the desired destination (e.g. <code>mv keptn /usr/local/bin/keptn</code>)</li>
<li><em>Windows</em>: Copy the executable to the desired folder and add the executable to your PATH environment variable.</li>
</ul>
</li>
</ul>
<p>Now, you should be able to run the Keptn CLI:</p>
<ul>
<li>Linux / macOS<pre><code>keptn --help
</code></pre>
</li>
<li>Windows<pre><code>.\keptn.exe --help
</code></pre>
</li>
</ul>
<aside class="special"><p>For the rest of the documentation we will stick to the <em>Linux / macOS</em> version of the commands.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Install Keptn in your cluster" duration="5">
        <p>To install the latest release of Keptn with full <em>quality gate + continuous delivery capabilities</em> in your Kubernetes cluster, execute the <code>keptn install</code> command.</p>
<pre><code>keptn install --endpoint-service-type=ClusterIP --use-case=continuous-delivery
</code></pre>
<aside class="special"><p>The installation process will take about 3-5 minutes.</p>
</aside>
<aside class="special"><p>Please note that Keptn comes with different installation options, all of the described in detail in the <a href="https://keptn.sh/docs/0.7.x/operate/install/" target="_blank">Keptn docs</a>.</p>
</aside>
<h2 is-upgraded>Installation details</h2>
<p>In the Keptn namespace, the following deployments should be found:</p>
<pre><code>kubectl get deployments -n keptn

NAME                                             READY   UP-TO-DATE   AVAILABLE   AGE
api-gateway-nginx                                1/1     1            1           2m44s
api-service                                      1/1     1            1           2m44s
bridge                                           1/1     1            1           2m44s
configuration-service                            1/1     1            1           2m44s
eventbroker-go                                   1/1     1            1           2m44s
gatekeeper-service                               1/1     1            1           2m44s
helm-service                                     1/1     1            1           2m44s
helm-service-continuous-deployment-distributor   1/1     1            1           2m44s
jmeter-service                                   1/1     1            1           2m44s
lighthouse-service                               1/1     1            1           2m44s
mongodb                                          1/1     1            1           2m44s
mongodb-datastore                                1/1     1            1           2m44s
remediation-service                              1/1     1            1           2m44s
shipyard-service                                 1/1     1            1           2m44s
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Configure Istio and Keptn" duration="0">
        <p>Get the <code>EXTERNAL-IP</code> from the <code>istio-ingressgateway</code> as you will need it in the next step</p>
<pre><code>kubectl -n istio-system get svc istio-ingressgateway
</code></pre>
<pre><code>NAME                   TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)                                                      AGE
istio-ingressgateway   LoadBalancer   10.0.171.50   40.125.XXX.XXX   15021:30094/TCP,80:32076/TCP,443:31452/TCP,15443:31721/TCP   2m36s
</code></pre>
<p>In my case it is something like <code>40.125.XXX.XXX</code>.</p>
<p>Create a file <code>ingress-manifest.yaml</code> and copy the following content.</p>
<pre><code>apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: istio
  name: api-keptn-ingress
  namespace: keptn
spec:
  rules:
  - host: &lt;IP-ADDRESS&gt;.nip.io
    http:
      paths:
      - backend:
          serviceName: api-gateway-nginx
          servicePort: 80
</code></pre>
<p>Next, make sure to replace the <code>&lt;IP-ADDRESS&gt;</code> with the actual IP of the ingress gateway that you just copied. Please note that we are using <a href="https://nip.io/" target="_blank">nip.io</a> (a wildcard DNS resolver) only for the purpose of this tutorial. In a production environment, you might want to use your own domain name here.</p>
<p>Now let&#39;s apply the manifest to the cluster.</p>
<pre><code>kubectl apply -f ingress-manifest.yaml
</code></pre>
<p>Next, we will also need a Gateway for Keptn. Therefore copy and paste the following content into a file named <code>gateway.yaml</code> and apply it to your Kubernetes cluster.</p>
<pre><code>---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: public-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      name: http
      number: 80
      protocol: HTTP
    hosts:
    - &#39;*&#39;
</code></pre>
<pre><code>kubectl apply -f gateway-manifest.yaml
</code></pre>
<p>Create a <code>ConfigMap</code> for Keptn to pick up with all the needed information. Therefore execute the following statement that will create the configmap.</p>
<pre><code>kubectl create configmap -n keptn ingress-config --from-literal=ingress_hostname_suffix=$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host}) --from-literal=ingress_port=${INGRESS_PORT} --from-literal=ingress_protocol=${INGRESS_PROTOCOL} --from-literal=istio_gateway=${ISTIO_GATEWAY} -oyaml --dry-run | kubectl replace -f -
</code></pre>
<p>Finally, restart the Helm service of Keptn to pick up the just created configuration.</p>
<pre><code>kubectl delete pod -n keptn -lapp.kubernetes.io/name=helm-service
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Connect your Keptn CLI to the Keptn installation" duration="0">
        <p>In this section we are referring to the Linux/MacOS derivates of the commands. If you are using a Windows host, please <a href="https://keptn.sh/docs/0.7.0/operate/install/#5-authenticate-keptn-cli" target="_blank">follow the official instructions</a>.</p>
<pre><code>KEPTN_ENDPOINT=http://$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})/api
KEPTN_API_TOKEN=$(kubectl get secret keptn-api-token -n keptn -ojsonpath={.data.keptn-api-token} | base64 --decode)
</code></pre>
<p>Use this stored information and authenticate the CLI.</p>
<pre><code>keptn auth --endpoint=$KEPTN_ENDPOINT --api-token=$KEPTN_API_TOKEN
</code></pre>
<p>That will give you:</p>
<pre><code>Starting to authenticate
Successfully authenticated
</code></pre>
<aside class="special"><p>Congratulations - Keptn is successfully installed and your CLI is connected to your Keptn installation!</p>
</aside>
<p>If you want, you can go ahead and take a look at the Keptn API by navigating to the endpoint that is given via</p>
<pre><code>echo $KEPTN_ENDPOINT
</code></pre>
<p class="image-container"><img alt="api" src="img/707f9b47ad623af9.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create your first project" duration="5">
        <p>A project in Keptn is the logical unit that can hold multiple (micro)services. Therefore, it is the starting point for each Keptn installation.</p>
<p>To get all files you need for this tutorial, please clone the example repo to your local machine.</p>
<pre><code>git clone --branch release-0.7.0 https://github.com/keptn/examples.git --single-branch

cd examples/onboarding-carts
</code></pre>
<p>Create a new project for your services using the <code>keptn create project</code> command. In this example, the project is called <em>sockshop</em>. Before executing the following command, make sure you are in the <code>examples/onboarding-carts</code> folder.</p>
<p><strong>Recommended:</strong> Create a new project with Git upstream:</p>
<p>To configure a Git upstream for this tutorial, the Git user (<code>--git-user</code>), an access token (<code>--git-token</code>), and the remote URL (<code>--git-remote-url</code>) are required. If a requirement is not met, go to <a href="https://keptn.sh/docs/0.7.0/manage/git_upstream/" target="_blank">the Keptn documentation</a> where instructions for GitHub, GitLab, and Bitbucket are provided.</p>
<pre><code>keptn create project sockshop --shipyard=./shipyard.yaml --git-user=GIT_USER --git-token=GIT_TOKEN --git-remote-url=GIT_REMOTE_URL
</code></pre>
<p><strong>Alternatively:</strong> If you don&#39;t want to use a Git upstream, you can create a new project without it but please note that this is not the recommended way:</p>
<pre><code>keptn create project sockshop --shipyard=./shipyard.yaml
</code></pre>
<p>For creating the project, the tutorial relies on a <code>shipyard.yaml</code> file as shown below:</p>
<pre><code>stages:
  - name: &#34;dev&#34;
    deployment_strategy: &#34;direct&#34;
    test_strategy: &#34;functional&#34;
  - name: &#34;staging&#34;
    approval_strategy: 
      pass: &#34;automatic&#34;
      warning: &#34;automatic&#34;
    deployment_strategy: &#34;blue_green_service&#34;
    test_strategy: &#34;performance&#34;
  - name: &#34;production&#34;
    approval_strategy: 
      pass: &#34;automatic&#34;
      warning: &#34;manual&#34;
    deployment_strategy: &#34;blue_green_service&#34;
    remediation_strategy: &#34;automated&#34;
</code></pre>
<p>This shipyard contains three stages: dev, staging, and production. This results in the three Kubernetes namespaces: sockshop-dev, sockshop-staging, and sockshop-production.</p>
<ul>
<li><strong>dev</strong> will have a direct (big bang) deployment strategy and functional tests are executed</li>
<li><strong>staging</strong> will have a blue/green deployment strategy with automated approvals for passing quality gates as well as quality gates which result in warnings. As configured, performance tests are executed.</li>
<li><strong>production</strong> will have a blue/green deployment strategy without any further testing. Approvals are done automatically for passed quality gates but manual approval is needed for quality gate evaluations that result in a warning. The configured remediation strategy is used for self-healing in production.</li>
</ul>
<aside class="special"><p>To learn more about a <em>shipyard</em> file, please take a look at the <a href="https://github.com/keptn/spec/blob/master/shipyard.md" target="_blank">Shipyard specification</a>.</p>
</aside>
<p>Let&#39;s take a look at the project that we have just created. We can find all this information in the Keptn&#39;s Bridge.<br>Therefore, we need the credentials that have been automatically generated for us.</p>
<pre><code>keptn configure bridge --output
</code></pre>
<p>Now use these credentials to access it on your Keptn endpoint.</p>
<pre><code>echo http://$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})/bridge
</code></pre>
<p>You will find the just created project in the bridge with all stages.<br><img alt="bridge" src="img/ea75605185cd741f.png"><img alt="bridge" src="img/d3919622be13ae7c.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Onboard first microservice" duration="5">
        <p>After creating the project, services can be onboarded to our project.</p>
<ol type="1">
<li>Onboard the <strong>carts</strong> service using the <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_onboard_service/" target="_blank">keptn onboard service</a> command:<pre><code>keptn onboard service carts --project=sockshop --chart=./carts
</code></pre>
</li>
<li>After onboarding the service, tests (i.e., functional- and performance tests) need to be added as basis for quality gates in the different stages:<ul>
<li>Functional tests for <em>dev</em> stage:<pre><code>keptn add-resource --project=sockshop --stage=dev --service=carts --resource=jmeter/basiccheck.jmx --resourceUri=jmeter/basiccheck.jmx
</code></pre>
</li>
<li>Performance tests for <em>staging</em> stage:<pre><code>keptn add-resource --project=sockshop --stage=staging --service=carts --resource=jmeter/load.jmx --resourceUri=jmeter/load.jmx
</code></pre>
</li>
</ul>
<strong>Note:</strong> You can adapt the tests in <code>basiccheck.jmx</code> as well as <code>load.jmx</code> for your service. However, you must not rename the files because there is a hardcoded dependency on these file names in the current implementation of Keptn&#39;s jmeter-service.</li>
</ol>
<p>Since the carts service requires a mongodb database, a second service needs to be onboarded.</p>
<ul>
<li>Onboard the <strong>carts-db</strong> service using the <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_onboard_service/" target="_blank">keptn onboard service</a> command. The <code>--deployment-strategy</code> flag specifies that for this service a <em>direct</em> deployment strategy in all stages should be used regardless of the deployment strategy specified in the shipyard. Thus, the database is not blue/green deployed.<pre><code>keptn onboard service carts-db --project=sockshop --chart=./carts-db --deployment-strategy=direct
</code></pre>
</li>
</ul>
<p>Take a look in your Keptn&#39;s Bridge and see the newly onboarded services.<br><img alt="bridge services" src="img/33106f7456894b04.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy first build with Keptn" duration="5">
        <p>After onboarding the services, a built artifact of each service can be deployed.</p>
<ol type="1">
<li>Deploy the carts-db service by executing the <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_send_event_new-artifact/" target="_blank">keptn send event new-artifact</a> command:<pre><code>keptn send event new-artifact --project=sockshop --service=carts-db --image=docker.io/mongo --tag=4.2.2
</code></pre>
</li>
<li>Deploy the carts service by specifying the built artifact, which is stored on DockerHub and tagged with version 0.11.1:<pre><code>keptn send event new-artifact --project=sockshop --service=carts --image=docker.io/keptnexamples/carts --tag=0.11.1
</code></pre>
</li>
<li>Go to Keptn&#39;s Bridge and check which events have already been generated.<br><img alt="bridge" src="img/5a1640c50f69de79.png"></li>
<li><strong>Optional:</strong> Verify the pods that should have been created for services carts and carts-db:<pre><code>kubectl get pods --all-namespaces | grep carts-
</code></pre>
<pre><code>sockshop-dev          carts-77dfdc664b-25b74                            1/1     Running     0          10m
sockshop-dev          carts-db-54d9b6775-lmhf6                          1/1     Running     0          13m
sockshop-production   carts-db-54d9b6775-4hlwn                          2/2     Running     0          12m
sockshop-production   carts-primary-79bcc7c99f-bwdhg                    2/2     Running     0          2m15s
sockshop-staging      carts-db-54d9b6775-rm8rw                          2/2     Running     0          12m
sockshop-staging      carts-primary-79bcc7c99f-mbbgq                    2/2     Running     0          7m24s
</code></pre>
</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="View carts service" duration="2">
        <ol type="1">
<li>Get the URL for your carts service with the following commands in the respective namespaces:<pre><code>echo http://carts.sockshop-dev.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
<pre><code>echo http://carts.sockshop-staging.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
<pre><code>echo http://carts.sockshop-production.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
</li>
<li>Navigate to the URLs to inspect the carts service. In the production namespace, you should receive an output similar to this:</li>
</ol>
<p class="image-container"><img alt="carts in production" src="img/da8218ae54b69582.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Generate traffic" duration="2">
        <p>Now that the service is running in all three stages, let us generate some traffic so we have some data we can base the evaluation on.</p>
<p>Change the directory to <code>examples/load-generation/cartsloadgen</code>. If you are still in the onboarding-carts directory, use the following command or change it accordingly:</p>
<pre><code>cd ../load-generation/cartsloadgen
</code></pre>
<p>Now let us deploy a pod that will generate some traffic for all three stages of our demo environment.</p>
<pre><code>kubectl apply -f deploy/cartsloadgen-base.yaml 
</code></pre>
<p>The output will look similar to this.</p>
<pre><code>namespace/loadgen created
deployment.extensions/cartsloadgen created
</code></pre>
<p>Optionally, you can verify that the load generator has been started.</p>
<pre><code>kubectl get pods -n loadgen

NAME                            READY   STATUS    RESTARTS   AGE
cartsloadgen-5dc47c85cf-kqggb   1/1     Running   0          117s
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Setup Prometheus Monitoring" duration="3">
        <p>After creating a project and service, you can setup Prometheus monitoring and configure scrape jobs using the Keptn CLI.</p>
<ol type="1">
<li>To install the <em>prometheus-service</em>, execute:<pre><code>kubectl apply -f https://raw.githubusercontent.com/keptn-contrib/prometheus-service/release-0.3.5/deploy/service.yaml
</code></pre>
</li>
<li>Execute the following command to set up the rules for the <em>Prometheus Alerting Manager</em>:<pre><code>keptn configure monitoring prometheus --project=sockshop --service=carts
</code></pre>
</li>
</ol>
<h2 is-upgraded>Optional: Verify Prometheus setup in your cluster</h2>
<ul>
<li>To verify that the Prometheus scrape jobs are correctly set up, you can access Prometheus by enabling port-forwarding for the prometheus-service:<pre><code>kubectl port-forward svc/prometheus-service 8080 -n monitoring
</code></pre>
</li>
</ul>
<p>Prometheus is then available on <a href="http://localhost:8080/targets" target="_blank">localhost:8080/targets</a> where you can see the targets for the service:<br><img alt="Prometheus targets" src="img/1ed161d9a1a28fc4.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Setup Prometheus SLI provider" duration="2">
        <p>During the evaluation of a quality gate, the Prometheus SLI provider is required that is implemented by an internal Keptn service, the <em>prometheus-sli-service</em>. This service will <em>fetch the values</em> for the SLIs that are referenced in an SLO configuration file.</p>
<p>To install the <em>prometheus-sli-service</em>, execute:</p>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/keptn-contrib/prometheus-sli-service/0.2.2/deploy/service.yaml
</code></pre>
<p>We are going to add the configuration for our SLIs in terms of an SLI file that maps the <em>name</em> of an indicator to a PromQL statement how to actually query it. Please make sure you are in the correct folder <code>examples/onboarding-carts</code>.</p>
<pre><code>keptn add-resource --project=sockshop --stage=production --service=carts --resource=sli-config-prometheus-selfhealing.yaml --resourceUri=prometheus/sli.yaml 
</code></pre>
<p>For your information, the contents of the file are as follows:</p>
<pre><code>---
spec_version: &#39;1.0&#39;
indicators:
  response_time_p50: histogram_quantile(0.5, sum by(le) (rate(http_response_time_milliseconds_bucket{handler=&#34;ItemsController.addToCart&#34;,job=&#34;$SERVICE-$PROJECT-$STAGE&#34;}[3m])))
  response_time_p90: histogram_quantile(0.9, sum by(le) (rate(http_response_time_milliseconds_bucket{handler=&#34;ItemsController.addToCart&#34;,job=&#34;$SERVICE-$PROJECT-$STAGE&#34;}[3m])))
  response_time_p95: histogram_quantile(0.95, sum by(le) (rate(http_response_time_milliseconds_bucket{handler=&#34;ItemsController.addToCart&#34;,job=&#34;$SERVICE-$PROJECT-$STAGE&#34;}[3m])))
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Set up the quality gate" duration="4">
        <p>Keptn requires a performance specification for the quality gate. This specification is described in a file called <code>slo.yaml</code>, which specifies a Service Level Objective (SLO) that should be met by a service. To learn more about the <em>slo.yaml</em> file, go to <a href="https://github.com/keptn/spec/blob/master/sre.md" target="_blank">Specifications for Site Reliability Engineering with Keptn</a>.</p>
<p>Activate the quality gates for the carts service. Therefore, navigate to the <code>examples/onboarding-carts</code> folder and upload the <code>slo-quality-gates.yaml</code> file using the <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_add-resource/" target="_blank">add-resource</a> command:</p>
<p>Make sure you are in the correct folder <code>examples/onboarding-carts</code>. If not, change the directory accordingly, e.g., <code>cd ../../onboarding-carts</code>.</p>
<pre><code>keptn add-resource --project=sockshop --stage=staging --service=carts --resource=slo-quality-gates.yaml --resourceUri=slo.yaml
</code></pre>
<p>This will add the <code>SLO.yaml</code> file to your Keptn - which is the declaritive definition of a quality gate. Let&#39;s take a look at the file contents:</p>
<pre><code>---
spec_version: &#34;1.0&#34;
comparison:
  aggregate_function: &#34;avg&#34;
  compare_with: &#34;single_result&#34;
  include_result_with_score: &#34;pass&#34;
  number_of_comparison_results: 1
filter:
objectives:
  - sli: &#34;response_time_p95&#34;
    key_sli: false
    pass:             # pass if (relative change &lt;= 10% AND absolute value is &lt; 600ms)
      - criteria:
          - &#34;&lt;=+10%&#34;  # relative values require a prefixed sign (plus or minus)
          - &#34;&lt;600&#34;    # absolute values only require a logical operator
    warning:          # if the response time is below 800ms, the result should be a warning
      - criteria:
          - &#34;&lt;=800&#34;
    weight: 1
total_score:
  pass: &#34;90%&#34;
  warning: &#34;75%&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Verify current version" duration="3">
        <p>You can take a look at the currently deployed version of our &#34;carts&#34; microservice before we deploy the next build of our microservice.</p>
<ol type="1">
<li>Get the URL for your carts service with the following commands in the respective stages:<pre><code>echo http://carts.sockshop-dev.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
<pre><code>echo http://carts.sockshop-staging.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
<pre><code>echo http://carts.sockshop-production.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
</li>
<li>Navigate to <code>http://carts.sockshop-production.YOUR.DOMAIN</code> for viewing the carts service in your <strong>production</strong> environment and you should receive an output similar to the following:</li>
</ol>
<p class="image-container"><img alt="carts service" src="img/da8218ae54b69582.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy a slow build version" duration="5">
        <ol type="1">
<li>Use the Keptn CLI to deploy a version of the carts service, which contains an artificial <strong>slowdown of 1 second</strong> in each request.<pre><code>keptn send event new-artifact --project=sockshop --service=carts --image=docker.io/keptnexamples/carts --tag=0.11.2
</code></pre>
</li>
<li>Go ahead and verify that the slow build has reached your <code>dev</code> and <code>staging</code> environments by opening a browser for both environments. Get the URLs with these commands:<pre><code>echo http://carts.sockshop-dev.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
<pre><code>echo http://carts.sockshop-staging.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
</li>
</ol>
<p class="image-container"><img alt="carts service" src="img/ac48a3cf213a8050.png"></p>
<p class="image-container"><img alt="carts service" src="img/e5cfc05c6bd13efb.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Quality gate in action" duration="7">
        <p>After triggering the deployment of the carts service in version v0.11.2, the following status is expected:</p>
<ul>
<li><strong>Dev stage:</strong> The new version is deployed in the dev stage and the functional tests passed.<ul>
<li>To verify, open a browser and navigate to:<pre><code>echo http://carts.sockshop-dev.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
</li>
</ul>
</li>
<li><strong>Staging stage:</strong> In this stage, version v0.11.2 will be deployed and the performance test starts to run for about 10 minutes. After the test is completed, Keptn triggers the test evaluation and identifies the slowdown. Consequently, a roll-back to version v0.11.1 in this stage is conducted and the promotion to production is not triggered.</li>
<li><strong>Production stage:</strong> The slow version is <strong>not promoted</strong> to the production stage because of the active quality gate in place. Thus, still version v0.11.1 is expected to be in production.<ul>
<li>To verify, navigate to:<pre><code>echo http://carts.sockshop-production.$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath={.spec.rules[0].host})
</code></pre>
</li>
</ul>
</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Verify the quality gate in Keptn&#39;s Bridge" duration="3">
        <p>Take a look in the Keptn&#39;s bridge and navigate to the last deployment. You will find a quality gate evaluation that got a <code>fail</code> result when evaluation the SLOs of our carts microservice. Thanks to this quality gate the slow build won&#39;t be promoted to production but instead automatically rolled back.</p>
<p>To verify, the <a href="https://keptn.sh/docs/0.7.x/reference/bridge/" target="_blank">Keptn&#39;s Bridge</a> shows the deployment of v0.11.2 and then the failed test in staging including the roll-back.</p>
<p class="image-container"><img alt="Keptn's bridge" src="img/f80e40846609edcd.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy a regular carts version" duration="3">
        <ol type="1">
<li>Use the Keptn CLI to send a new version of the <em>carts</em> artifact, which does <strong>not</strong> contain any slowdown:<pre><code>keptn send event new-artifact --project=sockshop --service=carts --image=docker.io/keptnexamples/carts --tag=0.11.3
</code></pre>
</li>
<li>To verify the deployment in <em>production</em> (it may take a couple of minutes), open a browser and navigate to the carts service in your production environment. As a result, you see <code>Version: v3</code>.</li>
<li>Besides, you can verify the deployments in your Kubernetes cluster using the following commands:<pre><code>kubectl get deployments -n sockshop-production
</code></pre>
<pre><code>NAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
carts-db        1         1         1            1           63m
carts-primary   1         1         1            1           98m
</code></pre>
<pre><code>kubectl describe deployment carts-primary -n sockshop-production
</code></pre>
<pre><code>...
Pod Template:
Labels:  app=carts-primary
Containers:
  carts:
    Image:      docker.io/keptnexamples/carts:0.11.3
</code></pre>
</li>
<li>Take another look into the Keptn&#39;s Bridge and you will see this new version passed the quality gate and thus, is now running in production!</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Enable Self-Healing" duration="2">
        <p>Next, you will learn how to use the capabilities of Keptn to provide self-healing for an application without modifying code. In the next part, we configure Keptn to scale up the pods of an application if the application undergoes heavy CPU saturation.</p>
<aside class="warning"><p>First, make sure you are in the correct folder <code>examples/onboarding-carts</code> otherwise the next commands will fail.</p>
</aside>
<p>Add the prepared SLO file for self-healing to the production stage using the Keptn CLIs add-resource command:</p>
<pre><code>keptn add-resource --project=sockshop --stage=production --service=carts --resource=slo-self-healing.yaml --resourceUri=slo.yaml
</code></pre>
<p>Note: The SLO file contains an objective for response_time_p90.</p>
<p>Configure Prometheus with the Keptn CLI (this configures the <a href="https://prometheus.io/docs/alerting/configuration/" target="_blank">Alert Manager</a> based on the slo.yaml file):</p>
<pre><code>keptn configure monitoring prometheus --project=sockshop --service=carts
</code></pre>
<p>Configure remediation actions for up-scaling based on Prometheus alerts:</p>
<pre><code>keptn add-resource --project=sockshop --stage=production --service=carts --resource=remediation.yaml --resourceUri=remediation.yaml
</code></pre>
<p>This is the content of the file that has being added:</p>
<pre><code>apiVersion: spec.keptn.sh/0.1.4
kind: Remediation
metadata:
  name: carts-remediation
spec:
  remediations:
    - problemType: Response time degradation
      actionsOnOpen:
        - action: scaling
          name: scaling
          description: Scale up
          value: 1
    - problemType: response_time_p90
      actionsOnOpen:
        - action: scaling
          name: scaling
          description: Scale up
          value: 1
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Generate load for the service" duration="3">
        <p>To simulate user traffic that is causing an unhealthy behavior in the carts service, please execute the following script. This will add special items into the shopping cart that cause some extensive calculation.</p>
<ol type="1">
<li>Move to the correct folder for the load generation scripts:<pre><code>cd ../load-generation/cartsloadgen/deploy
</code></pre>
</li>
<li>Start the load generation script:<pre><code>kubectl apply -f cartsloadgen-faulty.yaml
</code></pre>
</li>
<li>(optional:) Verify the load in Prometheus.<ul>
<li>Make a port forward to access Prometheus:<pre><code>kubectl port-forward svc/prometheus-service -n monitoring 8080:8080
</code></pre>
</li>
<li>Access Prometheus from your browser on <a href="http://localhost:8080" target="_blank">http://localhost:8080</a>.</li>
<li>In the <strong>Graph</strong> tab, add the expression<pre><code>histogram_quantile(0.9, sum by(le) (rate(http_response_time_milliseconds_bucket{job=&#34;carts-sockshop-production&#34;}[3m])))
</code></pre>
</li>
<li>Select the <strong>Graph</strong> tab to see your Response time metrics of the <code>carts</code> service in the <code>sockshop-production</code> environment.</li>
<li>You should see a graph which locks similar to this:</li>
</ul>
<img alt="Prometheus load" src="img/f52742e937341f9a.png"></li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Watch self-healing in action" duration="10">
        <p>After approximately 10-15 minutes, the <em>Alert Manager</em> will send out an alert since the <em>service level objective</em> is not met anymore.</p>
<p>To verify that an alert was fired, select the <em>Alerts</em> view where you should see that the alert <code>response_time_p90</code> is in the <code>firing</code> state:</p>
<p class="image-container"><img alt="Alert Manager" src="img/6d9f2770d2f4d2d9.png"></p>
<p>After receiving the problem notification, the <em>prometheus-service</em> will translate it into a Keptn CloudEvent. This event will eventually be received by the <em>remediation-service</em> that will look for a remediation action specified for this type of problem and, if found, execute it.</p>
<p>In this tutorial, the number of pods will be increased to remediate the issue of the response time increase.</p>
<ol type="1">
<li>Check the executed remediation actions by executing:<pre><code>kubectl get deployments -n sockshop-production
</code></pre>
You can see that the <code>carts-primary</code> deployment is now served by two pods:<pre><code>NAME             DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
carts-db         1         1         1            1           37m
carts-primary    2         2         2            2           32m
</code></pre>
</li>
<li>Also you should see an additional pod running when you execute:<pre><code>kubectl get pods -n sockshop-production
</code></pre>
<pre><code>NAME                              READY   STATUS    RESTARTS   AGE
carts-db-57cd95557b-r6cg8         1/1     Running   0          38m
carts-primary-7c96d87df9-75pg7    2/2     Running   0          33m
carts-primary-7c96d87df9-78fh2    2/2     Running   0          5m
</code></pre>
</li>
<li>To get an overview of the actions that got triggered by the response time SLO violation, you can use the Keptn&#39;s Bridge.In this example, the bridge shows that the remediation service triggered an update of the configuration of the carts service by increasing the number of replicas to 2. When the additional replica was available, the wait-service waited for ten minutes for the remediation action to take effect. Afterwards, an evaluation by the lighthouse-service was triggered to check if the remediation action resolved the problem. In this case, increasing the number of replicas achieved the desired effect, since the evaluation of the service level objectives has been successful.<img alt="Bridge - Remediation" src="img/6b02621cab92eea7.png"><img alt="Bridge - Remediation" src="img/ccf883d77e1bcfe5.png"></li>
<li>Furthermore, you can use Prometheus to double-check the response time:<img alt="Prometheus" src="img/fa77b4c459dd46a9.png"></li>
<li>Also, the Prometheus Alert Manager will show zero active alerts.<img alt="prometheus" src="img/bd08cd79fd021748.png"></li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Finish" duration="1">
        <p>Thanks for taking a full tour through Keptn!<br>Although Keptn has even more to offer that should have given you a good overview what you can do with Keptn.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>We have created a sample project with the Keptn CLI and set up a multi-stage delivery pipeline with the <code>shipyard</code> file<pre><code>stages:
- name: &#34;dev&#34;
  deployment_strategy: &#34;direct&#34;
  test_strategy: &#34;functional&#34;
- name: &#34;staging&#34;
  approval_strategy: 
    pass: &#34;automatic&#34;
    warning: &#34;automatic&#34;
  deployment_strategy: &#34;blue_green_service&#34;
  test_strategy: &#34;performance&#34;
- name: &#34;production&#34;
  approval_strategy: 
    pass: &#34;automatic&#34;
    warning: &#34;manual&#34;
  deployment_strategy: &#34;blue_green_service&#34;
  remediation_strategy: &#34;automated&#34;
</code></pre>
</li>
<li>We have set up quality gates based on service level objectives in our <code>slo</code> file<pre><code>---
spec_version: &#34;1.0&#34;
comparison:
aggregate_function: &#34;avg&#34;
compare_with: &#34;single_result&#34;
include_result_with_score: &#34;pass&#34;
number_of_comparison_results: 1
filter:
objectives:
- sli: &#34;response_time_p95&#34;
  key_sli: false
  pass:             # pass if (relative change &lt;= 10% AND absolute value is &lt; 600ms)
    - criteria:
        - &#34;&lt;=+10%&#34;  # relative values require a prefixed sign (plus or minus)
        - &#34;&lt;600&#34;    # absolute values only require a logical operator
  warning:          # if the response time is below 800ms, the result should be a warning
    - criteria:
        - &#34;&lt;=800&#34;
  weight: 1
total_score:
pass: &#34;90%&#34;
warning: &#34;75%&#34;
</code></pre>
</li>
<li>We have tested our quality gates by deploying a bad build to our cluster and verified that Keptn quality gates stopped them.<br><img alt="bridge" src="img/f80e40846609edcd.png"></li>
<li>We have set up self-healing to automatically scale our application<br><img alt="Bridge - Remediation" src="img/ca581d187026cfc7.png"></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Getting started with Keptn integrations" duration="3">
        <p>Keptn can be easily extended with external tools such as notification tools, other <a href="link to docs" target="_blank">SLI providers</a>, bots to interact with Keptn, etc.<br>While we do not cover additional integrations in this tutorial, please feel fee to take a look at our integration repositories:</p>
<ul>
<li><a href="https://github.com/keptn-contrib" target="_blank">Keptn Contrib</a> lists mature Keptn integrations that you can use for your Keptn installation</li>
<li><a href="https://github.com/keptn-sandbox" target="_blank">Keptn Sandbox</a> collects mostly new integrations and those that are currently under development - however, you can also find useful integrations here.</li>
</ul>
<aside class="special"><p>We are happy to receive your contributions - please <a href="https://github.com/keptn-sandbox/contributing" target="_blank">follow this guide</a> if you want to contribute your own services to Keptn</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Feedback" duration="0">
        <aside class="special"><p>We are happy to hear your feedback!</p>
</aside>
<p>Please visit us in our <a href="https://slack.keptn.sh" target="_blank">Keptn Slack</a> and tell us how you like Keptn and this tutorial! We are happy to hear your thoughts &amp; suggestions!</p>
<p>Also, make sure to <a href="https://twitter.com/keptnProject" target="_blank">follow us on Twitter</a> to get the latest news on Keptn, our tutorials and newest releases!</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
